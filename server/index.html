<!DOCTYPE html>
<html>

    <head>
        <meta charset="UTF-8">
        <title>Bike Energy Meter</title>
    </head>

    <body>
        <h1>Bike Energy Meter</h1>
        <ul id="messages"></ul>

        <canvas id="wheel-freq" width="500" height="50" style="border:2px solid #c3c3e3;">
            Your browser does not support the HTML5 canvas tag.
        </canvas>
    </body>

    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        $(function()
        {
            // Initialize variables
            const socket = io();
            var wheelFreq = 0.0;

            // Socket.io listeners
            socket.on('new message', (msg) =>
            {
                displayMessage(msg);
            });

            socket.on('close', () =>
            {
                displayMessage('Lost connection to device.');
            });

            socket.on('wheel-turn', (freq) =>
            {
                /*
                var newWheelFreq = freq / 256.0;
                var factor = (wheelFreq + newWheelFreq) * 0.5;

                wheelFreq = (1.0 - factor) * wheelFreq + factor * newWheelFreq;
                */

                // Shift register test
                wheelFreq = (Math.log(freq) / Math.log(2.0) + 1.0) / 8.0;
            });

            // Functions
            function sendData(data)
            {
                socket.send(data);
            }

            function displayMessage(msg)
            {
                $('#messages').append($('<li>').text(msg));
            }

            // Canvas drawing
            var canvas = document.getElementById("wheel-freq");
            var context = canvas.getContext("2d");
            var gradient = context.createLinearGradient(0, 0, canvas.width, 0);

            gradient.addColorStop(0.0, "black");
            gradient.addColorStop(0.5, "green");
            gradient.addColorStop(1.0, "red");

            window.requestAnimationFrame =
                window.requestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.msRequestAnimationFrame;

            function draw(timestamp)
            {
                context.fillStyle = gradient;
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.fillRect(0, 0, canvas.width * wheelFreq, canvas.height);

                /*
                if (wheelFreq > 0.0)
                    wheelFreq -= 0.001;
                */

                window.requestAnimationFrame(draw);
            }

            window.requestAnimationFrame(draw);
        });

    </script>

</html>
